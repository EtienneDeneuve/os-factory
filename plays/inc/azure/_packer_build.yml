---
- name: "{{ work_breadcrumb }} - validate server image"
  shell: >-
    packer validate
    {{ osf_packer_build }}
    > {{ osf_packer_logs }} 2>&1
  retries: 2
  delay: 60

- name: "{{ work_breadcrumb }} - build server image"
  shell: >-
    packer -machine-readable build
    {{ osf_packer_build }}
    > {{ osf_packer_logs }} 2>&1
  retries: 2
  delay: 60

- name: "Get image vhd name from packer output"
  shell: >-
    grep OSDiskUri: {{ osf_packer_logs }} | grep -oP 'http.?://\S+' | grep -oP temp-osDisk.*.vhd | uniq   
  register: temp_vhd_filename

- name: "Debug Packer Output"
  debug:
    msg: "{{ temp_vhd_filename.stdout }}"

- name: "Set vhd fact"
  set_fact: vhd_fact={{ temp_vhd_filename.stdout }}

- name: "Debug Packer Output"
  debug:
    msg: "{{ vhd_fact }}"
    
    
    
    #   -var 'arm_rg_name={{ azure_ressource_group }}'
    # -var 'arm_sub_id={{ azure_subscription_id }}'
    # -var 'arm_tenant_id={{ tenant_id }}'
    # -var 'build_rg_image_name={{ azure_ressource_group }}'
    # -var 'build_vnet_name={{ azure_vnet_name }}'
    # -var 'build_vnet_rg={{ azure_ressource_group }}'
    # -var 'build_snet_name={{ azure_subnet_name }}'
    # -var 'build_image_name={{ osf_target_name }}.vhd'
    # -var 'build_vm_size=Standard_DS3_V2'
    # -var 'build_region={{ azure_region }}'
    # -var 'build_default_user={{ build_user }}'
    # -var 'os_type={{ build_user }}'
    # -var 'image_publisher={{ image_publisher }}'
    # -var 'image_offer={{ image_offer }}'
    # -var 'image_sku={{ image_sku }}'
    # -var 'playbook_build={{ osf_ref_dir }}'
    # -var 'playbook_roles={{ osf_work_dir }}/roles'
    # -var 'json_output_path={{ osf_packer_output }}'
    # -var 'temp_resource_group_name=rg-temp-osf-{{ 99999999 |random(1, 10) }}'
    # -var 'temp_compute_name=vm-temp-osf-{{ 99999999 |random(1, 10) }}'