---
- name: "{{ work_breadcrumb }} - build server image"
  shell: >-
    packer build
    -var 'build_name={{ osf_target_name }}'
    -var 'build_default_user={{ build_user }}'
    -var 'build_http_directory={{ osf_work_dir }}/script'
    -var 'build_iso_url={{image_url}}'
    -var 'build_iso_checksum={{image_checksum}}'
    -var 'build_guest_os_type={{os_guest_type}}'
    -var 'build_region={{ aws_region }}'
    -var 'import_bucket={{ bucket_import }}'
    -var 'playbook_build={{ osf_ref_dir }}'
    -var 'playbook_roles={{ osf_work_dir }}/roles'
    -var 'json_output_path={{ osf_packer_output }}'
    {{ osf_packer_build }}
    > {{ osf_packer_logs }} 2>&1
  retries: 2
  delay: 60
